const express = require("express");
const pool = require("./Database/db");

const app = express();
const port = 2700;

app.use(express.json());

app.get("/getdata", async (req, res) => {
  try {
    const search = req.query.search || "";
    const sorted = req.query.sorted || "name";
    const order = req.query.order || "order";

    const validSorted = ["name", "email"];
    const validOrder = ["asc", "desc"];

    const sortedBy = validSorted.includes(sorted) ? sorted : "name";
    const orderby = validOrder.includes(order.toLocaleString())
      ? order.toLocaleString()
      : "asc";

    const result = await pool.query(
      `SELECT * FROM employees WHERE name ILIKE $1 OR email ILIKE $1 ORDER BY ${sortedBy} ${orderby}`,
      [`%${search}%`]
    );
    return res.status(200).json({ data: result.rows });
  } catch (error) {
    return res.status(500).json({ message: error.message });
  }
});

app.listen(port, () => console.log(`Server Started AT port ${port}`));
